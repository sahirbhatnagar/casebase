<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Time-Varying Covariates • casebase</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Time-Varying Covariates">
<meta property="og:description" content="casebase">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">casebase</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.10.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/popTime.html">Population Time Plots</a>
    </li>
    <li>
      <a href="../articles/smoothHazard.html">Fitting smooth-in-time parametric hazard functions</a>
    </li>
    <li>
      <a href="../articles/plotsmoothHazard.html">Plotting Hazards and Hazard Ratios</a>
    </li>
    <li>
      <a href="../articles/plotabsRisk.html">Plot Cumulative Incidence and Survival Curves</a>
    </li>
    <li>
      <a href="../articles/competingRisk.html">Competing risk analysis using case-base sampling</a>
    </li>
    <li>
      <a href="../articles/customizingpopTime.html">Customizing Population Time Plots</a>
    </li>
    <li>
      <a href="../articles/time-varying-covariates.html">Time-Varying Covariates</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/sahirbhatnagar/casebase/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Time-Varying Covariates</h1>
                        <h4 data-toc-skip class="author">Maxime
Turgeon</h4>
            
            <h4 data-toc-skip class="date">2024-04-09</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/sahirbhatnagar/casebase/blob/HEAD/vignettes/time-varying-covariates.Rmd" class="external-link"><code>vignettes/time-varying-covariates.Rmd</code></a></small>
      <div class="hidden name"><code>time-varying-covariates.Rmd</code></div>

    </div>

    
    
<p>In the previous case studies, we only considered covariates that were
fixed at baseline. In this next case study, we will use the Stanford
Heart Transplant data <span class="citation">(Clark et al. 1971)</span>
<span class="citation">(Crowley and Hu 1977)</span> to show how
case-base sampling can also be used in the context of time-varying
covariates. As an example that already appeared in the literature,
case-base sampling was to study vaccination safety, where the exposure
period was defined as the week following vaccination <span class="citation">(Saarela 2015)</span>. Hence, the main covariate of
interest, i.e. exposure to the vaccine, was changing over time. In this
context, case-base sampling offers an efficient alternative to nested
case-control designs or self-matching.</p>
<p>Recall the setting of Stanford Heart Transplant study: patients were
admitted to the Stanford program after meeting with their physician and
determining that they were unlikely to respond to other forms of
treatment. After enrollment, the program searched for a suitable donor
for the patient, which could take anywhere between a few days to almost
a year. We are interested in the effect of a heart transplant on
survival; therefore, the patient is considered exposed only after the
transplant has occurred.</p>
<p>As before, we can look at the population-time plot for a graphical
summary of the event incidence. As we can see, most events occur early
during the follow-up period, and therefore we do not expect the hazard
to be constant.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sahirbhatnagar.com/casebase/">casebase</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">stanford_popTime</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/popTime.html">popTime</a></span><span class="op">(</span><span class="va">jasa</span>, time <span class="op">=</span> <span class="st">"futime"</span>, </span>
<span>                            event <span class="op">=</span> <span class="st">"fustat"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">stanford_popTime</span><span class="op">)</span></span></code></pre></div>
<p><img src="time-varying-covariates_files/figure-html/stanford-poptime-1.png" width="700"></p>
<p>Since the exposure is time-dependent, we need to manually define the
exposure variable <em>after</em> case-base sampling and <em>before</em>
fitting the hazard function. For this reason, we will use the
<code>sampleCaseBase</code> function directly.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">cb_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sampleCaseBase.html">sampleCaseBase</a></span><span class="op">(</span><span class="va">jasa</span>, time <span class="op">=</span> <span class="st">"futime"</span>, </span>
<span>                          event <span class="op">=</span> <span class="st">"fustat"</span>, ratio <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>Next, we will compute the number of days from acceptance into the
program to transplant, and we use this variable to determine whether
each population-moment is exposed or not.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define exposure variable</span></span>
<span><span class="va">cb_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">cb_data</span>,</span>
<span>                  txtime <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/time_length.html" class="external-link">time_length</a></span><span class="op">(</span><span class="va">accept.dt</span> <span class="op"><a href="https://lubridate.tidyverse.org/reference/interval.html" class="external-link">%--%</a></span> <span class="va">tx.date</span>, </span>
<span>                                       unit <span class="op">=</span> <span class="st">"days"</span><span class="op">)</span>,</span>
<span>                  exposure <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">txtime</span><span class="op">)</span> <span class="op">~</span> <span class="fl">0L</span>,</span>
<span>                    <span class="va">txtime</span> <span class="op">&gt;</span> <span class="va">futime</span> <span class="op">~</span> <span class="fl">0L</span>,</span>
<span>                    <span class="va">txtime</span> <span class="op">&lt;=</span> <span class="va">futime</span> <span class="op">~</span> <span class="fl">1L</span></span>
<span>                  <span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we can fit the hazard using various linear predictors.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">splines</span><span class="op">)</span></span>
<span><span class="co"># Fit several models</span></span>
<span><span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitSmoothHazard.html">fitSmoothHazard</a></span><span class="op">(</span><span class="va">fustat</span> <span class="op">~</span> <span class="va">exposure</span>,</span>
<span>                        data <span class="op">=</span> <span class="va">cb_data</span>, time <span class="op">=</span> <span class="st">"futime"</span><span class="op">)</span></span>
<span><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitSmoothHazard.html">fitSmoothHazard</a></span><span class="op">(</span><span class="va">fustat</span> <span class="op">~</span> <span class="va">exposure</span> <span class="op">+</span> <span class="va">futime</span>,</span>
<span>                        data <span class="op">=</span> <span class="va">cb_data</span>, time <span class="op">=</span> <span class="st">"futime"</span><span class="op">)</span></span>
<span><span class="va">fit3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitSmoothHazard.html">fitSmoothHazard</a></span><span class="op">(</span><span class="va">fustat</span> <span class="op">~</span> <span class="va">exposure</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/splines/bs.html" class="external-link">bs</a></span><span class="op">(</span><span class="va">futime</span><span class="op">)</span>,</span>
<span>                        data <span class="op">=</span> <span class="va">cb_data</span>, time <span class="op">=</span> <span class="st">"futime"</span><span class="op">)</span></span>
<span><span class="va">fit4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitSmoothHazard.html">fitSmoothHazard</a></span><span class="op">(</span><span class="va">fustat</span> <span class="op">~</span> <span class="va">exposure</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/splines/bs.html" class="external-link">bs</a></span><span class="op">(</span><span class="va">futime</span><span class="op">)</span>,</span>
<span>                        data <span class="op">=</span> <span class="va">cb_data</span>, time <span class="op">=</span> <span class="st">"futime"</span><span class="op">)</span></span></code></pre></div>
<p>Note that the fourth model (i.e. <code>fit4</code>) includes an
interaction term between exposure and follow-up time. In other words,
this model no longer exhibit proportional hazards. The evidence of
non-proportionality of hazards in the Stanford Heart Transplant data has
been widely discussed <span class="citation">(Arjas 1988)</span>.</p>
<p>We can then compare the goodness of fit of these four models using
the Akaike Information Criterion (AIC).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute AIC</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Model1"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">)</span>,</span>
<span>  <span class="st">"Model2"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">fit2</span><span class="op">)</span>,</span>
<span>  <span class="st">"Model3"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">fit3</span><span class="op">)</span>,</span>
<span>  <span class="st">"Model4"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/AIC.html" class="external-link">AIC</a></span><span class="op">(</span><span class="va">fit4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Model1   Model2   Model3   Model4 </span></span>
<span><span class="co">#&gt; 493.2688 454.6240 441.4930 445.1944</span></span></code></pre></div>
<p>As we can, the best fit is the third model.</p>
<p>By visualizing the hazard functions for both exposed and unexposed
individuals, we can visualize the non-proportionality of the fourth
model.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute hazards---</span></span>
<span><span class="co"># First, create a list of time points for both exposure status</span></span>
<span><span class="va">hazard_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>exposure <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                           futime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1000</span>,</span>
<span>                                        length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Set the offset to zero</span></span>
<span><span class="va">hazard_data</span><span class="op">$</span><span class="va">offset</span> <span class="op">&lt;-</span> <span class="fl">0</span> </span>
<span><span class="co"># Use predict to get the fitted values, and exponentiate to </span></span>
<span><span class="co"># transform to the right scale</span></span>
<span><span class="va">hazard_data</span><span class="op">$</span><span class="va">hazard</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit4</span>, newdata <span class="op">=</span> <span class="va">hazard_data</span>,</span>
<span>                                 type <span class="op">=</span> <span class="st">"link"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Add labels for plots</span></span>
<span><span class="va">hazard_data</span><span class="op">$</span><span class="va">Status</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">hazard_data</span><span class="op">$</span><span class="va">exposure</span>,</span>
<span>                            labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"NoTrans"</span>, <span class="st">"Trans"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">hazard_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">futime</span>, <span class="va">hazard</span>, colour <span class="op">=</span> <span class="va">Status</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'top'</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">'Hazard'</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">'Follow-up time'</span><span class="op">)</span></span></code></pre></div>
<p><img src="time-varying-covariates_files/figure-html/stanford-hazard-1.png" width="700"></p>
<p>The non-proportionality seems to be more pronounced at the beginning
of follow-up than the end.</p>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-arjas1988graphical" class="csl-entry">
Arjas, Elja. 1988. <span>“A Graphical Method for Assessing Goodness of
Fit in Cox’s Proportional Hazards Model.”</span> <em>Journal of the
American Statistical Association</em> 83 (401): 204–12.
</div>
<div id="ref-clark1971cardiac" class="csl-entry">
Clark, David A, Edward B Stinson, Randall B Griepp, John S Schroeder,
Norman E Shumway, and Donald Harrison. 1971. <span>“Cardiac
Transplantation in Man.”</span> <em>Annals of Internal Medicine</em> 75
(1): 15–21.
</div>
<div id="ref-crowley1977covariance" class="csl-entry">
Crowley, John, and Marie Hu. 1977. <span>“Covariance Analysis of Heart
Transplant Survival Data.”</span> <em>Journal of the American
Statistical Association</em> 72 (357): 27–36.
</div>
<div id="ref-saarela2015case" class="csl-entry">
Saarela, Olli. 2015. <span>“A Case-Base Sampling Method for Estimating
Recurrent Event Intensities.”</span> <em>Lifetime Data Analysis</em>,
1–17.
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://sahirbhatnagar.com/" class="external-link">Sahir Bhatnagar</a>, <a href="https://maxturgeon.ca/" class="external-link">Maxime Turgeon</a>, <a href="https://www.jesseislam.com/" class="external-link">Jesse Islam</a>, <a href="http://individual.utoronto.ca/osaarela/" class="external-link">Olli Saarela</a>, <a href="http://www.medicine.mcgill.ca/epidemiology/hanley/" class="external-link">James Hanley</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
